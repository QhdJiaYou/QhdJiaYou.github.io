<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  
  
  <title>
    React Context从入门到实践 |
    
    Hexo
  </title>
  
    <link rel="shortcut icon" href="/favicon.ico">
    
  
<link rel="stylesheet" href="/css/style.css">

  
  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<script src="/js/pace.min.js"></script>

<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <main class="content">
    <section class="outer">
  <article id="post-React Context从入门到实践" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      

<h1 class="article-title" itemprop="name">
  React Context从入门到实践
</h1>



    </header>
    

    
    <div class="article-meta">
      <a href="/2021/07/13/React%20Context%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E8%B7%B5/" class="article-date">
  <time datetime="2021-07-13T09:50:43.000Z" itemprop="datePublished">2021-07-13</time>
</a>
      
    </div>
    

    
    
<div class="tocbot"></div>

    

    <div class="article-entry" itemprop="articleBody">
      
      
      
      <h2 id="Why-为什么要有React-Context"><a href="#Why-为什么要有React-Context" class="headerlink" title="Why-为什么要有React Context"></a>Why-为什么要有React Context</h2><h3 id="1-1-父子组件通信"><a href="#1-1-父子组件通信" class="headerlink" title="1.1 父子组件通信"></a>1.1 父子组件通信</h3><p>父传子：父组件通过props传递给子组件</p>
<p>子传父：父组件传递一个回调函数给子组件，子组件可以将需要传递给父组件的数据传入这个回调函数参数</p>
<h3 id="1-2-兄弟组件通信"><a href="#1-2-兄弟组件通信" class="headerlink" title="1.2 兄弟组件通信"></a>1.2 兄弟组件通信</h3><p>使用父组件作为桥梁，维护state变量，给兄弟组件传递props，兄弟组件修改父组件中的state</p>
<h3 id="1-3-层级较深的组件间通信"><a href="#1-3-层级较深的组件间通信" class="headerlink" title="1.3 层级较深的组件间通信"></a>1.3 层级较深的组件间通信</h3><p>(现有应用场景: 比如React Router组件、react-redux数据流管理)</p>
<p>使用Context API</p>
<p>官方定义: Context 提供了一个无需为每层组件手动添加 props，就能在组件树间进行数据传递的方法 </p>
<p>所以context设计的目的是为了共享对于一个组件树而言是”全局”的数据,例如当前登陆用户信息、主题、首选语言等等。</p>
<h2 id="What-怎么用React-Context"><a href="#What-怎么用React-Context" class="headerlink" title="What-怎么用React Context"></a>What-怎么用React Context</h2><h3 id="React-createContext"><a href="#React-createContext" class="headerlink" title="React.createContext"></a><code>React.createContext</code></h3><p>消费组件只有在组件树中没有找到匹配的Provider时, defaultValue的值才会生效(即使给Prodiver的value传undefined, defaultValue也不会生效)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ThemedButton = React.createContext(defaultValue);</span><br></pre></td></tr></table></figure>

<h3 id="Context-Provider"><a href="#Context-Provider" class="headerlink" title="Context.Provider"></a><code>Context.Provider</code></h3><ol>
<li>每个 Context 对象都会返回一个 Provider React 组件，它允许消费组件订阅 context 的变化</li>
<li>多个 Provider 也可以嵌套使用，里层的会覆盖外层的数据</li>
<li>当 Provider 的 value 值发生变化时(比较value值变化使用的是Object.is)，它内部的所有消费组件都会重新渲染(不受制于shouldComponentUpdate、React.PureComponent、React.memo、useMemo等)</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;ThemedButton.Provider value=&#123;<span class="comment">/* 某个值 */</span>&#125;&gt;</span><br></pre></td></tr></table></figure>
<p>基于第3点,  我们传递给context值是复杂对象类型时,需要注意书写方式</p>
<h3 id="Class-contextType类中使用方式"><a href="#Class-contextType类中使用方式" class="headerlink" title="Class.contextType类中使用方式"></a><code>Class.contextType</code>类中使用方式</h3><p>给挂载在class上的contextType赋值一个context对象，就可以在类的任何生命周期中(除了constructor构造函数), 通过this.context访问到它的值</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThemedButton</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="attr">context</span>: React.ContextType&lt;<span class="keyword">typeof</span> ThemeContext&gt;</span><br><span class="line">    <span class="keyword">static</span> contextType = ThemeContext <span class="comment">// 方式1</span></span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;button(this.context)&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> <span class="comment">// 方式2</span></span><br><span class="line">ThemedButton.contextType = ThemeContext;</span><br></pre></td></tr></table></figure>

<h3 id="useContextHook中使用方式"><a href="#useContextHook中使用方式" class="headerlink" title="useContextHook中使用方式"></a><code>useContext</code>Hook中使用方式</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> value = useContext(ThemeContext);</span><br></pre></td></tr></table></figure>

<h3 id="Context-Consumer"><a href="#Context-Consumer" class="headerlink" title="Context.Consumer"></a><code>Context.Consumer</code></h3><p>函数式和class中都可以使用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThemedButton</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      	<span class="comment">// 这里是使用了render props的方式,传递一个函数作为子组件</span></span><br><span class="line">        <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">ThemeContext.Consumer</span>&gt;</span>&#123;value =&gt;/* 基于Context值进行渲染*/&#125;<span class="tag">&lt;/<span class="name">ThemeContext.Consumer</span>&gt;</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="How-如何实践React-Context"><a href="#How-如何实践React-Context" class="headerlink" title="How-如何实践React Context"></a>How-如何实践React Context</h2><h3 id="简单实现react-router-dom内容"><a href="#简单实现react-router-dom内容" class="headerlink" title="简单实现react-router-dom内容"></a>简单实现react-router-dom内容</h3><h4 id="1、react-router-dom的基本API和使用"><a href="#1、react-router-dom的基本API和使用" class="headerlink" title="1、react-router-dom的基本API和使用"></a>1、react-router-dom的基本API和使用</h4><p>首先我们简单回顾下</p>
<p>该模块包含两种路由, 分别是HashRouter和BrowserRouter, 其中HashRouter是采用hash值变化来切换路由, BrowserRouter是采用history API来切换路由</p>
<p>我们用HashRouter或者BrowserRouter包裹页面内容</p>
<p>在需要使用路由的地方,引入Route组件 (没有使用Route的组件或者页面,如果想拿到路由信息,可以使用withRouter包裹)</p>
<p>如果想显示切换链接, 就会用到Link组件 (也可以在任何能拿到路由信息的位置手动切换路由)</p>
<p>为了避免路径匹配时,会匹配到多个Route, 我们可以用Switch将一组Route包裹起来, 这样只会渲染匹配到的第一个Route</p>
<p>为了避免所有路径都无法匹配, 可以通过Redirect组件重定向到某个页面(比如空的兜底页面)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;HashRouter&gt;</span><br><span class="line">        <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">Link</span> <span class="attr">to</span>=<span class="string">&quot;/&quot;</span>&gt;</span>Home<span class="tag">&lt;/<span class="name">Link</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">Link</span> <span class="attr">to</span>=<span class="string">&quot;/paent&quot;</span>&gt;</span>redirect<span class="tag">&lt;/<span class="name">Link</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">Link</span> <span class="attr">to</span>=<span class="string">&quot;/parent&quot;</span>&gt;</span>Parent<span class="tag">&lt;/<span class="name">Link</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">Link</span> <span class="attr">to</span>=<span class="string">&quot;/comment&quot;</span>&gt;</span>Comment<span class="tag">&lt;/<span class="name">Link</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">Link</span> <span class="attr">to</span>=<span class="string">&quot;/study&quot;</span>&gt;</span>Study Context<span class="tag">&lt;/<span class="name">Link</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">Link</span> <span class="attr">to</span>=<span class="string">&quot;/countNum&quot;</span>&gt;</span>Count<span class="tag">&lt;/<span class="name">Link</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">        <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">Switch</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">Route</span> <span class="attr">exact</span> <span class="attr">path</span>=<span class="string">&quot;/&quot;</span> <span class="attr">component</span>=<span class="string">&#123;AppPage&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&quot;/parent&quot;</span> <span class="attr">component</span>=<span class="string">&#123;Parent&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&quot;/comment&quot;</span> <span class="attr">component</span>=<span class="string">&#123;Comment&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&quot;/study&quot;</span> <span class="attr">component</span>=<span class="string">&#123;Study&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&quot;/countNum&quot;</span> <span class="attr">component</span>=<span class="string">&#123;CountNum&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">Redirect</span> <span class="attr">to</span>=<span class="string">&quot;/parent&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">Switch</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"> &lt;/HashRouter&gt;</span><br></pre></td></tr></table></figure>

<h4 id="2、实现基本原理"><a href="#2、实现基本原理" class="headerlink" title="2、实现基本原理"></a>2、实现基本原理</h4><p>利用Context API ,通过将context对象注入到Router组件(HashRouter或者BrowserRouter)中, Router组件的render()返回的渲染内容就是该context对象的Provider组件,value值就是当前路由信息对象, 里面渲染props.children内容.</p>
<p>也就是只要被它包围的子组件,都有机会获取到当前路由信息. 比如Router组件下面的Switch、Route、 Link、 Redirect等, 他们获取到之后可以改变当前路由信息, 从而实现动态切换Route组件的渲染</p>
<p>下面我们实现一个简单版本的react-router-dom</p>
<p><strong>导出context对象,保存全局路由信息</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// context.tsx</span></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> topContext = React.createContext(&#123;&#125;);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> topContext;</span><br></pre></td></tr></table></figure>

<p><strong>实现HashRouter</strong></p>
<p>在react中，当前路由信息对象包含了location、match、history三个对象，为了方便操作，我们将location和match对象定义到state中，因为这两个对象中的数据是需要在Router内部动态修改的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// HashRouter.jsx</span></span><br><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> Context <span class="keyword">from</span> <span class="string">&quot;./context&quot;</span>; <span class="comment">// 引入上下文对象</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">HashRouter</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 在HashRouter中新增构造函数，并且将location和match定义到state对象中</span></span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(props);</span><br><span class="line">        <span class="built_in">this</span>.state = &#123; <span class="comment">// 为了方便更改当前路由信息，将location和match放到state中</span></span><br><span class="line">            <span class="attr">location</span>: &#123;</span><br><span class="line">                <span class="attr">pathname</span>: <span class="built_in">window</span>.location.hash.slice(<span class="number">1</span>) || <span class="string">&quot;/&quot;</span>, <span class="comment">// 获取浏览器地址栏中的hash值，如果不存在则默认为&quot;/&quot;</span></span><br><span class="line">                <span class="attr">query</span>: <span class="literal">undefined</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">match</span>: &#123;</span><br><span class="line">                <span class="attr">params</span>: <span class="literal">undefined</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 子组件调用history.push方法更新location</span></span><br><span class="line">        <span class="comment">// 监听hash值变化,更新全局location对象, HashRouter下面的子组件Route就会重新渲染</span></span><br><span class="line">        <span class="built_in">window</span>.addEventListener(<span class="string">&quot;hashchange&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">                <span class="attr">location</span>: &#123;</span><br><span class="line">                    ...this.state.location,</span><br><span class="line">                    <span class="attr">pathname</span>: <span class="built_in">window</span>.location.hash.slice(<span class="number">1</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 当前路由对象</span></span><br><span class="line">        <span class="keyword">const</span> currentRoute = &#123;</span><br><span class="line">            <span class="attr">location</span>: <span class="built_in">this</span>.state.location,</span><br><span class="line">            <span class="attr">match</span>: <span class="built_in">this</span>.state.match,</span><br><span class="line">            <span class="comment">// 新增一个history对象用于实现当前路由的切换</span></span><br><span class="line">            <span class="attr">history</span>: &#123;</span><br><span class="line">                <span class="attr">push</span>: <span class="function">(<span class="params">to</span>) =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">typeof</span> to === <span class="string">&quot;object&quot;</span>) &#123; <span class="comment">// 如果to是一个对象</span></span><br><span class="line">                        <span class="keyword">let</span> &#123; pathname, query &#125; = to; <span class="comment">// 取出pathname和query, react中还有search、state等参数，这里只以query为例。</span></span><br><span class="line">                        <span class="built_in">window</span>.location.hash = pathname; <span class="comment">// 更新浏览器hash值，触发浏览器hashchange事件</span></span><br><span class="line">                       <span class="comment">// this.state.location.pathname = pathname;</span></span><br><span class="line">                        <span class="built_in">this</span>.state.location.query = query; <span class="comment">// 更新query</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="built_in">window</span>.location.hash = to; <span class="comment">// 更新浏览器hash值</span></span><br><span class="line">                    &#125;</span><br><span class="line">                  <span class="comment">// 这部分只是修改了浏览器的地址栏,要想Router组件以及子组件重新渲染,还得通过监听hashchange事件, 调用setState实现</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="comment">// 使用上下文对象提供的Provider组件将当前路由信息对象注入上下文中，以便其Route等子组件能够获取到当前路由信息</span></span><br><span class="line">            <span class="xml"><span class="tag">&lt;<span class="name">Context.Provider</span> <span class="attr">value</span>=<span class="string">&#123;currentRoute&#125;</span>&gt;</span></span></span><br><span class="line"><span class="xml">                &#123;this.props.children&#125;</span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">Context.Provider</span>&gt;</span></span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>实现Route组件</strong></p>
<p>Route组件主要做的事,从context对象中拿到当前路由信息,跟传入的path参数进行对比,如果相同或者匹配, 则渲染出Route组件上配置的component内容,否则返回null</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Route.jsx</span></span><br><span class="line"><span class="keyword">import</span> React, &#123;Component&#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> context <span class="keyword">from</span> <span class="string">&quot;./context&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Route</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> currentRoutePath = <span class="built_in">this</span>.context.location.pathname; <span class="comment">// 从上下文中获取到当前路由的路径</span></span><br><span class="line">        <span class="keyword">const</span> &#123;path, <span class="attr">component</span>:MyComponent&#125; = <span class="built_in">this</span>.props; <span class="comment">// 获取给Route组件传递的props属性</span></span><br><span class="line">        <span class="keyword">const</span> comProps = &#123;</span><br><span class="line">            ...this.context</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (currentRoutePath === path) &#123;</span><br><span class="line">            <span class="keyword">return</span> (</span><br><span class="line">                <span class="xml"><span class="tag">&lt;<span class="name">MyComponent</span> &#123;<span class="attr">...comProps</span>&#125; /&gt;</span></span></span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>; <span class="comment">// 必须有返回值</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">Route.contextType = Context;</span><br></pre></td></tr></table></figure>

<p>支持带冒号的参数路径、支持exact, 主要用到了<a target="_blank" rel="noopener" href="https://github.com/pillarjs/path-to-regexp">path-to-regexp</a>模块</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Route.jsx</span></span><br><span class="line"><span class="keyword">import</span> Context <span class="keyword">from</span> <span class="string">&quot;./context&quot;</span>; <span class="comment">// 引入上下文对象</span></span><br><span class="line"><span class="comment">// match方法可以拿到匹配的params，pathToRegexp可以检测路径是否匹配成功</span></span><br><span class="line"><span class="keyword">import</span> &#123; pathToRegexp, match &#125; <span class="keyword">from</span> <span class="string">&quot;path-to-regexp&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Route</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取当前路由path</span></span><br><span class="line">        <span class="keyword">const</span> currentRoutePath = <span class="built_in">this</span>.context.location.pathname;</span><br><span class="line">        <span class="keyword">const</span> &#123;path, <span class="attr">component</span>: MyComponent, exact = <span class="literal">false</span>, render&#125; = <span class="built_in">this</span>.props;</span><br><span class="line">        <span class="comment">// 针对复杂,带参数路由</span></span><br><span class="line">        <span class="keyword">const</span> genParamsObjFun = match(path, &#123;<span class="attr">end</span>: exact&#125;); <span class="comment">// 生成正则校验函数</span></span><br><span class="line">        <span class="keyword">const</span> paramsRes = genParamsObjFun(currentRoutePath);</span><br><span class="line">        <span class="comment">// 将匹配的参数 赋值 给全局match对象的params</span></span><br><span class="line">        <span class="built_in">this</span>.context.match.params = paramsRes.params;</span><br><span class="line">        <span class="keyword">const</span> comProps = &#123;</span><br><span class="line">            ...this.context,</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 生成匹配path的正则表达式</span></span><br><span class="line">        <span class="keyword">const</span> pathReg = pathToRegexp(path, [], &#123;<span class="attr">end</span>: exact&#125;);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;pathmatch&#x27;</span>, pathReg.test(currentRoutePath), path, currentRoutePath);</span><br><span class="line">        <span class="keyword">if</span> (pathReg.test(currentRoutePath)) &#123;</span><br><span class="line">            <span class="keyword">return</span> render ? render() : <span class="xml"><span class="tag">&lt;<span class="name">MyComponent</span> &#123;<span class="attr">...comProps</span>&#125; /&gt;</span></span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">Route.contextType = Context;</span><br></pre></td></tr></table></figure>

<p><strong>实现Link组件</strong></p>
<p>本质上就是a标签,当点击时修改全局路由信息, 通过history.push修改</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Link.jsx</span></span><br><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> context <span class="keyword">from</span> <span class="string">&quot;./context&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Link</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> &#123; to &#125; = <span class="built_in">this</span>.props; <span class="comment">// 从Link组件上获取到配置的to路径</span></span><br><span class="line">        <span class="comment">// 点击Link的时候调用当前路由的history的push方法进行跳转即可</span></span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">          <span class="xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="xml">            this.context.history.push(to);</span></span><br><span class="line"><span class="xml">          &#125;&#125;&gt;&#123;this.props.children&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">Link.contextType = context;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>实现Redirect组件</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Redirect.jsx</span></span><br><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> context <span class="keyword">from</span> <span class="string">&quot;./context&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Redirect</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 直接重定向跳转到指定的路径</span></span><br><span class="line">        <span class="built_in">this</span>.context.history.push(<span class="built_in">this</span>.props.to);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">Redirect.contextType = context;</span><br></pre></td></tr></table></figure>
<p><strong>实现Switch组件</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> context <span class="keyword">from</span> <span class="string">&quot;./context&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; pathToRegexp &#125; <span class="keyword">from</span> <span class="string">&quot;path-to-regexp&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Switch</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="comment">// static contextType = context;</span></span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> children = <span class="built_in">Array</span>.isArray(<span class="built_in">this</span>.props.children) ? <span class="built_in">this</span>.props.children : [<span class="built_in">this</span>.props.children];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; children.length; i++) &#123; <span class="comment">// 遍历Switch组件下的所有子组件</span></span><br><span class="line">            <span class="keyword">const</span> child = children[i];</span><br><span class="line">            <span class="keyword">const</span> &#123; path = <span class="string">&quot;/&quot;</span>, exact = <span class="literal">false</span> &#125; = child.props;</span><br><span class="line">            <span class="keyword">const</span> &#123; pathname &#125; = <span class="built_in">this</span>.context.location;</span><br><span class="line">            <span class="keyword">const</span> regexp = pathToRegexp(path, [], &#123; <span class="attr">end</span>: exact &#125;);</span><br><span class="line">            <span class="keyword">if</span> (regexp.test(pathname)) &#123; <span class="comment">// 如果匹配成功则立即返回作为&lt;Switch&gt;组件的渲染结果</span></span><br><span class="line">                <span class="keyword">return</span> child;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">Switch.contextType = context;</span><br></pre></td></tr></table></figure>

<p><strong>实现BrowserRouter组件</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123;Component&#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> Context <span class="keyword">from</span> <span class="string">&quot;./context&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">BrowserRouter</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(props);</span><br><span class="line">        <span class="built_in">this</span>.state = &#123;</span><br><span class="line">            <span class="attr">location</span>: &#123;</span><br><span class="line">                <span class="attr">pathname</span>: <span class="built_in">window</span>.location.pathname || <span class="string">&quot;/&quot;</span>,</span><br><span class="line">                <span class="attr">query</span>: <span class="literal">undefined</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">match</span>: &#123;</span><br><span class="line">                <span class="attr">params</span>: <span class="literal">undefined</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">window</span>.addEventListener(<span class="string">&quot;popstate&quot;</span>, <span class="function">() =&gt;</span> &#123; <span class="comment">// 监听浏览器前进后退按钮</span></span><br><span class="line">            <span class="built_in">this</span>.setState(&#123; <span class="comment">// 触发页面更新</span></span><br><span class="line">                <span class="attr">location</span>: &#123;</span><br><span class="line">                    <span class="attr">pathname</span>: <span class="built_in">window</span>.location.pathname <span class="comment">// 路径变化后更新当前路由对应的pathname</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> currentRoute = &#123; </span><br><span class="line">            <span class="attr">location</span>: <span class="built_in">this</span>.state.location,</span><br><span class="line">            <span class="attr">match</span>: <span class="built_in">this</span>.state.match,</span><br><span class="line">            <span class="attr">history</span>: &#123; <span class="comment">// 新增一个history对象用于实现当前路由的切换</span></span><br><span class="line">                <span class="attr">push</span>: <span class="function">(<span class="params">to</span>) =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">typeof</span> to === <span class="string">&quot;object&quot;</span>) &#123; <span class="comment">// 如果to是一个对象</span></span><br><span class="line">                        <span class="keyword">let</span> &#123;pathname, query&#125; = to; <span class="comment">// 取出pathname和query</span></span><br><span class="line">                        <span class="built_in">this</span>.state.location.query = query; <span class="comment">// 更新query</span></span><br><span class="line">                        <span class="built_in">this</span>.state.location.pathname = pathname;<span class="comment">// 更新当前路由对应的pathname</span></span><br><span class="line">                        <span class="built_in">window</span>.history.pushState(&#123;&#125;, <span class="string">&quot;&quot;</span>, pathname); <span class="comment">// 添加一条history</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123; <span class="comment">// 如果to是一个路径字符串</span></span><br><span class="line">                        <span class="built_in">this</span>.state.location.pathname = to; <span class="comment">// 更新当前路由对应的pathname</span></span><br><span class="line">                        <span class="built_in">window</span>.history.pushState(&#123;&#125;, <span class="string">&quot;&quot;</span>, to); <span class="comment">// 添加一条history</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="built_in">this</span>.setState(&#123;&#125;); <span class="comment">// 触发页面更新</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="comment">// 使用上下文提供的Provider组件将当前路由信息对象注入上下文中，以便其Route子组件能够获取到当前路由信息</span></span><br><span class="line">            <span class="xml"><span class="tag">&lt;<span class="name">Context.Provider</span> <span class="attr">value</span>=<span class="string">&#123;currentRoute&#125;</span>&gt;</span></span></span><br><span class="line"><span class="xml">                &#123;this.props.children&#125;</span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">Context.Provider</span>&gt;</span></span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后,将所有内容统一导出</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> HashRouter <span class="keyword">from</span> <span class="string">&quot;./HashRouter.jsx&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> BrowserRouter <span class="keyword">from</span> <span class="string">&quot;./BrowserRouter.jsx&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> Link <span class="keyword">from</span> <span class="string">&quot;./Link.jsx&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> Route <span class="keyword">from</span> <span class="string">&quot;./Route.jsx&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> Redirect <span class="keyword">from</span> <span class="string">&quot;./Redirect.jsx&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> Switch <span class="keyword">from</span> <span class="string">&quot;./Switch.jsx&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">    HashRouter,</span><br><span class="line">    BrowserRouter,</span><br><span class="line">    Link,</span><br><span class="line">    Route,</span><br><span class="line">    Redirect,</span><br><span class="line">    Switch,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="简单实现react-redux内容"><a href="#简单实现react-redux内容" class="headerlink" title="简单实现react-redux内容"></a>简单实现react-redux内容</h3><h4 id="1、-react-redux基本功能"><a href="#1、-react-redux基本功能" class="headerlink" title="1、 react-redux基本功能"></a>1、 react-redux基本功能</h4><p>首先回顾下react-redux解决了什么问题, 当我们的某些数据,需要在多个页面,多个组件间共享时, 而且这些组件跨层级, 这个时候就需要用到react-redux提供的公共状态管理功能,并且当数据有更新的时候,所有用到的组件都能及时监听到变化.</p>
<p>页面最外层会包裹一个Provider组件,没错这个就是提供全局context用的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;Provider store=&#123;dva._store&#125;&gt;</span><br><span class="line">      <span class="xml"><span class="tag">&lt;<span class="name">Router</span> /&gt;</span></span></span><br><span class="line"> &lt;/Provider&gt;</span><br></pre></td></tr></table></figure>

<p>_store对象提供我们定义好的model</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> defaultState = &#123;</span><br><span class="line">    <span class="attr">selectedOrgId</span>: <span class="number">1</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">type State = <span class="keyword">typeof</span> defaultState;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ListModel: Dva.Model = &#123;</span><br><span class="line">    <span class="attr">namespace</span>: <span class="string">&#x27;list&#x27;</span>,</span><br><span class="line">    <span class="attr">state</span>: &#123;</span><br><span class="line">        ...defaultState,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">effects</span>: &#123;</span><br><span class="line">       </span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">reducers</span>: &#123;</span><br><span class="line">        <span class="function"><span class="title">setOrg</span>(<span class="params">state: State, &#123; payload &#125;: any</span>)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> &#123; ...state, <span class="attr">selectedOrgId</span>: payload + <span class="number">1</span> &#125;;</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> ListModel;</span><br></pre></td></tr></table></figure>

<p>需要使用这些公共状态的地方会用connect高阶函数调用, 分别传递两个函数, 这两个函数都返回对象类型值</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mapStateToProps</span>(<span class="params">&#123; list &#125;: any</span>): <span class="title">any</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        ...list,</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mapDispatchToProps</span>(<span class="params">dispatch: any</span>): <span class="title">any</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">setOrgID</span>: <span class="function">(<span class="params">payload: any</span>) =&gt;</span> dispatch(&#123; <span class="attr">type</span>: <span class="string">&#x27;list/setOrg&#x27;</span>, payload &#125;),</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(mapStateToProps, mapDispatchToProps)(Parent);</span><br></pre></td></tr></table></figure>

<h4 id="2、实现基本原理-1"><a href="#2、实现基本原理-1" class="headerlink" title="2、实现基本原理"></a>2、实现基本原理</h4><p>要想实现这样的共享的数据，首先想到的必是建一个全局模块，里面存放很多公共的数据。就像这样</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">  <span class="attr">count</span>: <span class="number">0</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当状态改变的时候,直接赋值操作不好,容易误操作影响到其他组件, 并且不易排查错误</p>
<p>既然是共享数据，外部又不能直接改变它，当然就是一个闭包啦</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createStore</span>(<span class="params">initialState, reducer</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> currentState = initialState || &#123;&#125;</span><br><span class="line">    <span class="comment">// 存放观察者的队列</span></span><br><span class="line">    <span class="keyword">let</span> observers = []</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getState</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> currentState;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span>(<span class="params">action</span>) </span>&#123;</span><br><span class="line">        currentState = reducer(currentState, action)</span><br><span class="line">        <span class="comment">// 每次currentState改变, 重新执行观察者队列内容,更新视图</span></span><br><span class="line">        observers.forEach(<span class="function"><span class="params">fn</span> =&gt;</span> fn());</span><br><span class="line">    &#125;</span><br><span class="line">    dispatch(&#123; <span class="attr">type</span>: <span class="string">&#x27;@@REDUX_INIT&#x27;</span> &#125;)</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">subscribe</span>(<span class="params">fn</span>) </span>&#123;</span><br><span class="line">        observers.push(fn)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        getState,</span><br><span class="line">        dispatch,</span><br><span class="line">        subscribe,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3、手动实现过程"><a href="#3、手动实现过程" class="headerlink" title="3、手动实现过程"></a>3、手动实现过程</h4><p>实现Provider组件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">&#x27;React&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> Context <span class="keyword">from</span> <span class="string">&#x27;./context.jsx&#x27;</span>;</span><br><span class="line"><span class="comment">// import store from &#x27;./createStore.jsx&#x27;;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Provider</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="built_in">this</span>.props.store);</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="xml"><span class="tag">&lt;<span class="name">Context.Provider</span> <span class="attr">value</span>=<span class="string">&#123;this.props.store&#125;</span>&gt;</span></span></span><br><span class="line"><span class="xml">                &#123;this.props.children&#125;</span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">Context.Provider</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实现connect组件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">&#x27;React&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; shallowEqual &#125; <span class="keyword">from</span> <span class="string">&#x27;react-redux&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> context <span class="keyword">from</span> <span class="string">&#x27;./context.jsx&#x27;</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">connect</span>(<span class="params">mapStateToProps, mapDispatchToProps</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">WrappedComponent</span>) </span>&#123;</span><br><span class="line">        <span class="class"><span class="keyword">class</span> <span class="title">Connect</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">            <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">                <span class="built_in">super</span>(props);</span><br><span class="line">                <span class="built_in">this</span>.state = &#123;</span><br><span class="line">                    <span class="attr">storeState</span>: <span class="literal">null</span>,</span><br><span class="line">                    <span class="attr">mapDispatch</span>: <span class="literal">null</span>,</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> store = <span class="built_in">this</span>.context;</span><br><span class="line">                <span class="keyword">const</span> &#123; storeState &#125; = <span class="built_in">this</span>.state;</span><br><span class="line">                <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">                    <span class="attr">storeState</span>: mapStateToProps(<span class="built_in">this</span>.context.getState()),</span><br><span class="line">                    <span class="attr">mapDispatch</span>: mapDispatchToProps(<span class="built_in">this</span>.context.dispatch)</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="comment">// 如果store中的状态改变,就会执行这个回调函数,此时获取新的state和旧的做对比,如果变化了,就setState</span></span><br><span class="line">                store.subscribe(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">const</span> mappedState = mapStateToProps(store.getState());</span><br><span class="line">                    <span class="keyword">if</span> (shallowEqual(storeState, mappedState)) &#123;</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">                            <span class="attr">storeState</span>: mappedState,</span><br><span class="line">                        &#125;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> &#123; storeState, mapDispatch &#125; = <span class="built_in">this</span>.state;</span><br><span class="line">                <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">WrappedComponent</span> &#123;<span class="attr">...this.props</span>&#125; &#123;<span class="attr">...storeState</span>&#125; &#123;<span class="attr">...mapDispatch</span>&#125; /&gt;</span></span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Connect.contextType = context;</span><br><span class="line">        <span class="keyword">return</span> Connect</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/07/13/React%20Context%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E8%B7%B5/" data-id="clpuo0yva0006otmue9if0sqa" class="article-share-link">
        Share
      </a>
      
    </footer>

  </div>

  
  
<nav class="article-nav">
  
  <a href="/2021/10/26/%E5%88%9D%E8%AF%86webpack/" class="article-nav-link">
    <strong class="article-nav-caption">Newer</strong>
    <div class="article-nav-title">
      
      了解webpack
      
    </div>
  </a>
  
  
  <a href="/2020/11/26/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" class="article-nav-link">
    <strong class="article-nav-caption">Older</strong>
    <div class="article-nav-title">计算机网络基础</div>
  </a>
  
</nav>

  

  
  
  
  

</article>
</section>
    <footer class="footer">
  <div class="outer">
    <div class="float-right">
      <ul class="list-inline">
  
  <li><i class="fe fe-smile-alt"></i> <span id="busuanzi_value_site_uv"></span></li>
  
  <li><i class="fe fe-bookmark"></i> <span id="busuanzi_value_page_pv"></span></li>
  
</ul>
    </div>
    <ul class="list-inline">
      <li>Hexo &copy; 2023</li>
      
        <li>quhandong</li>
      
      <li>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></li>
      <!-- <li>theme  <a target="_blank" rel="noopener" href="https://github.com/zhwangart/hexo-theme-ocean">Ocean</a></li> -->
    </ul>
  </div>
</footer>
  </main>
  <aside class="sidebar">
    <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/hexo.svg" alt="Hexo"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">Home</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">Archives</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" target="_blank" rel="noopener" href="https://www.douyin.com/user/MS4wLjABAAAA4EevfdHrS1s-urfPJWWJEs-_c_qLu19jtr-eYdpBNBk?enter_from=main_page&enter_method=top_bar">Gallery</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/2022/07/01/README/">About</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      <div class="totop" id="totop">
  <i class="fe fe-rocket"></i>
</div>
    </li>
    <li class="nav-item">
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
  </aside>
  
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/lazyload.min.js"></script>



<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/copybtn.js"></script>





<script src="/js/tocbot.min.js"></script>

<script>
  // Tocbot_v4.7.0  http://tscanlin.github.io/tocbot/
  tocbot.init({
    tocSelector: '.tocbot',
    contentSelector: '.article-entry',
    headingSelector: 'h1, h2, h3, h4, h5, h6',
    hasInnerContainers: true,
    scrollSmooth: true,
    positionFixedSelector: '.tocbot',
    positionFixedClass: 'is-position-fixed',
    fixedSidebarOffset: 'auto',
  });
</script>



<script src="/js/ocean.js"></script>

</body>

</html>